<div class="card h-100 bg-white overflow-y-auto">
	<div class="card-header bg-transparent d-flex justify-content-between align-items-center">
		<div class="d-flex gap-2 align-items-center">
			<button *ngIf="!showInfo" pButton icon="pi pi-info-circle" label="Open Info" class="btn-primary text-dark me-1" (click)="openInfo.emit(true)"></button>
			<div class="uniabroad-icon me-2">
				<p-avatar styleClass="avatar-img" [image]="companyDetails?.company_logo ?? 'uniprep-assets/images/avatar.webp'" size="large" shape="circle" />
			</div>
			<div>
				<h5 class="mb-0 fw-bold">{{ companyDetails?.company_name }}</h5>
				<p class="small text-success mb-0 text-start">{{ organizationStatus }}</p>
			</div>
		</div>
		<button type="button" *ngIf="showInfo" class="btn-close" aria-label="Close" (click)="closeChat.emit(true)"></button>
	</div>
	<div class="card-body">
		<div class="h-100 d-flex flex-column">
			<!-- Body - Scrollable content -->
			<div class="card-body p-0 flex-grow-1 overflow-hidden d-flex flex-column no-scrollbar" style="height: calc(100vh - 455px)">
				<!-- Initial View (Empty State) -->
				<!-- <div class="chat-body h-100 overflow-y-auto" *ngIf="messages?.length < 1">
          <div class="description-box m-3 py-4 rounded-3" style="background-color: #edeff4">
            <h5 class="text-center mb-3">Write a description about yourself</h5>

            <div class="upload-section text-center">
              <p class="mb-1">Upload Cover Letter</p>
              <p class="small text-muted">Supported Formats: doc, docx, pdf, upto 2 MB</p>
            </div>
          </div>
          <div class="cover-letter-box m-3 py-4 rounded-3" style="background-color: #f9e9d8">
            <p class="text-center">Need a cover letter?</p>
            <button pButton class="p-button-text p-button-plain w-100" label="Click here to write one!"
              routerLink="/pages/job-tool/coverletter-builder"></button>
          </div>
        </div> -->

				<div #scrollContainer class="card-body h-100 overflow-y-auto overflow-x-hidden no-scrollbar" *ngIf="messages?.length > 0">
					<div>
						<!-- Progress bar section -->
						<div class="progress-container my-2 d-block d-lg-none">
							<div class="progress-steps d-flex">
								<div class="progress-step flex-fill" *ngFor="let stage of stages; let i = index">
									<p-progressBar [value]="stage.completed ? 100 : 0" [showValue]="false" [style]="{ height: '6px' }"></p-progressBar>
									<div class="text-left">{{ i + 1 + " " + stage.name }}</div>
								</div>
							</div>
						</div>
						<ng-container *ngFor="let message of messages; let i = index">
							<div class="d-flex mb-2" [id]="'item-' + message.id" #msgRef>
								<!-- Left Avatar (Company/Admin) -->
								<div class="avatar me-1" *ngIf="message.added_by != 'Student'">
									<p-avatar [image]="message?.icon ?? 'uniprep-assets/images/avatar.webp'" shape="circle" />
								</div>

								<div class="w-100 d-flex flex-column text-end" [ngClass]="message.added_by == 'Student' ? 'align-items-end' : 'align-items-start'">
									<!-- Text Message -->
									<div *ngIf="!message.attachment_url" class="message-content text-start" [ngClass]="message.added_by == 'Student' ? 'bg-secondary text-white' : 'bg-secondary-subtle'" [ngStyle]="{ 'max-width': '75%' }">
										<p [innerHTML]="message.chat"></p>
										<div class="d-flex justify-content-between align-items-center flex-row-reverse">
											<div>
												<span *ngIf="message.added_by == 'Student'" class="ms-2 text-white-50">
													<i class="fa-solid fa-check-double" [style.color]="message?.markAsRead ? 'skyblue' : 'lightgray'"></i>
												</span>
											</div>
											<small class="message-time text-end" [ngClass]="message.added_by == 'Student' ? 'text-white' : 'text-muted'">
												{{ message.time }}
											</small>
										</div>
									</div>

									<!-- File Message -->
									<div *ngIf="message.attachment_url" class="message-content file-message text-start" style="min-width: 50%" [ngClass]="message.added_by == 'Student' ? 'bg-secondary text-white' : 'bg-secondary-subtle'">
										<a [href]="message.attachment_url" target="_blank" class="text-decoration-none d-flex align-items-center" [ngClass]="message.added_by == 'Student' ? 'text-white' : 'text-black'" download>
											<i class="fas fa-file-pdf fa-large me-2"></i>
											{{ message.attachment || "File" }}
										</a>
										<div class="">{{ message.content }}</div>
										<small class="message-time text-start" [ngClass]="message.added_by == 'Student' ? 'text-white' : 'text-muted'">{{ message.time }}</small>
									</div>

									<!-- Button Message -->
									<div *ngIf="message.type === 'button'" style="max-width: 75%">
										<button pButton class="p-button-warning w-100 d-flex justify-content-between align-items-center">
											<span>{{ message.chat }}</span>
											<div class="d-flex align-items-center">
												<small class="me-2">{{ message.time }}</small>
											</div>
										</button>
									</div>
								</div>

								<!-- Right Avatar (Student) -->
								<div class="avatar ms-2" *ngIf="message.added_by == 'Student'">
									<p-avatar [image]="profileData?.dp_image ?? 'uniprep-assets/images/avatar.webp'" shape="circle" />
								</div>
							</div>
						</ng-container>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="card-footer bg-transparent border-0" style="background-color: transparent">
		<div class="w-100 mb-1 d-flex justify-content-end bg-transparent">
			<button *ngIf="messages?.length !== 0 || messageInput?.value?.length !== 0; else isLoadingAiSummary" class="text-small text-end btn btn-danger btn-rounded d-flex align-items-center gap-2" style="width: fit-content" (click)="aiGenerateSummary('RePhrase', { content: messageInput.value, mode: 'student' }, messageInput)">RePhrase</button>
			<ng-template #isLoadingAiSummary>
				<button class="text-small text-end btn btn-success btn-rounded d-flex align-items-center gap-2" style="width: fit-content" (click)="aiGenerateSummary('AI generate', { talent_name: aiGenerateChatDetails?.studentName, company_name: aiGenerateChatDetails.companyName, job_lookingfor: profileData?.careerPreference?.job_title, created_at: aiGenerateChatDetails?.createdAt, mode: 'student' }, messageInput)">Ai Generate</button>
			</ng-template>
		</div>
		<input type="file" class="d-none" accept=".doc,.docx,.pdf, application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" #fileAttachment (change)="uploadFilesChat($event)" />
		<div *ngIf="attachmentFile" class="border d-flex justify-content-between align-items-center p-2">
			<div>{{ attachmentFile.name }}</div>
			<i class="fas fa-xmark" (click)="attachmentFile = null; attachmentFileName = null"></i>
		</div>
		<div class="d-flex gap-2 align-items-center">
			<div class="input-group rounded-4 p-1 h-auto" style="border: 1px solid #e8e8e8">
				<textarea class="form-control border-0 overflow-auto" [placeholder]="'Text with ... ' + companyDetails?.company_name" [(ngModel)]="message" #messageInput rows="1" style="resize: none; min-height: 38px; max-height: 200px" (input)="autoGrow($event.target)" (keyup.enter)="sendMessage(message); message = ''; autoGrow(messageInput)"> </textarea>
				<span role="button" class="input-group-text border-0 bg-white" (click)="fileAttachment.click()">
					<i class="fa-solid fa-paperclip"></i>
				</span>
				<span role="button" class="input-group-text border-0 bg-white" *ngIf="isFollowed" (click)="sendMessage(messageInput.value); messageInput.value = ''; autoGrow(messageInput)">
					<i class="fa-solid fa-paper-plane-top" style="color: var(--uniprep-secondary)"></i>
				</span>
			</div>
			<div *ngIf="!isFollowed">
				<button class="btn btn-secondary" (click)="onFollowCompany(messageInput.value); messageInput.value = ''; autoGrow(messageInput)">Connect</button>
			</div>
		</div>
	</div>
</div>
