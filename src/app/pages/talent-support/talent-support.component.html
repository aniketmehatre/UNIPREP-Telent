<div class="card readingcard">

    <div class="card-header border-0 bg-transparent">
        <div class="row justify-content-center">
            <div class="col-md-12 d-flex gap-2 text-center">
                <div class="select-title d-flex justify-content-between align-items-center" style="width: 100%">
                    <div>
                        <h5 class="mb-0">
                            <span>Talent Support</span>
                        </h5>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <button pButton class="btn btn-primary p-2 px-4 py-2" [ngStyle]="{ width:'160px' }">
                            <i class="pi pi-book me-2"></i>Guide
                        </button>
                        <button class="how-it-works-button" pButton>How it works?<i
                                class="fa-solid fa-play d-md-block d-none"></i></button>
                    </div>
                </div>
            </div>
            <div class="col-md-12 d-flex justify-content-end gap-2 mt-3">
                <button pButton type="button" (click)="loadTalentSupport()" *ngIf="!supportView" class="btn btn-primary btn-rounded py-2 px-4">
                    <i class="pi pi-history"></i>
                    <span>History</span>
                </button>
            
                <button pButton type="button" (click)="supportView = !supportView" *ngIf="supportView"
                    class="btn btn-primary btn-rounded py-2 px-4">
                    <i class="pi pi-plus"></i><span>New</span>
                </button>
            </div>
        </div>
    </div>

    <div class="card-body d-flex flex-column hs-body" *ngIf="!supportView">
        <form [formGroup]="form" class="d-flex flex-column gap-3 flex-fill">

            <!-- Scrollable content area -->
            <div class="hs-scroll d-flex flex-column gap-3">
                <ng-container formArrayName="requirements">
                    <div class="requirement" *ngFor="let req of requirements.controls; let i = index"
                        [formGroupName]="i">
                        <div class="d-flex justify-content-between align-items-center requirement-header" role="button"
                            (click)="toggleExpand(i)">
                            <div class="fw-semibold">Requirement {{ i + 1 }}</div>
                            <div class="d-flex gap-2 align-items-center">
                                <button type="button" class="btn btn-sm btn-outline-danger"
                                    *ngIf="requirements.length > 1"
                                    (click)="removeRequirement(i); $event.stopPropagation()">Remove
                                </button>
                                <i class="pi"
                                    [ngClass]="(req.get('expanded')?.value ? 'pi-chevron-up' : 'pi-chevron-down')"></i>
                            </div>
                        </div>

                        <div class="requirement-body" *ngIf="req.get('expanded')?.value">
                            <div class="mb-3">
                                <label class="form-label">Talent Requirement Plan</label>
                                <p-button icon="pi pi-info-circle" styleClass="p-button-text info-icon"
                                    [pTooltip]="tooltipContent" tooltipPosition="right" [tooltipAppendTo]="'body'">
                                </p-button>

                                <p-select formControlName="requirementType" [options]="talentRequirementPlans"
                                    aria-placeholder="Select Talent Requirement Plan" (onChange)="onValueChange($event)"
                                    placeholder="Select Talent Requirement Plan" optionLabel="label" fluid
                                    appendTo="body" class="w-100" optionValue="value">
                                </p-select>
                                <small class="text-danger" *ngIf="isFieldInvalid(i, 'requirementType')">
                                    {{ getFieldError(i, 'requirementType') }}
                                </small>
                                <ng-template #tooltipContent>
                                    <div class="tooltip-note">
                                        <strong>Note:</strong><br />
                                        Silver - ₹3,999<br />
                                        Platinum - ₹6,999<br />
                                        Diamond - ₹9,999
                                    </div>
                                </ng-template>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Job Title You Are Looking For</label>
                                <p-select [virtualScroll]="true" [virtualScrollItemSize]="50" formControlName="jobTitle"
                                    [options]="positions || []" placeholder="Select the job"
                                    optionLabel="position_title" optionValue="id"
                                    (onFilter)="onDropdownFilter($event)" styleClass="w-100" [filter]="true"
                                    dataKey="id" filterBy="position_title" [showClear]="true"
                                    (mouseover)="onFocusInput('title')" (mouseout)="resetMessageBox()" fluid
                                    appendTo="body">
                                    <ng-template #header>
                                        <div class="p-2" (click)="$event.stopPropagation()">
                                            <p-inputgroup>
                                                <input pInputText class="rounded-end-2 me-1"
                                                    placeholder="Custom Job Title" #jobTitleExp
                                                    (click)="$event.stopPropagation(); focusInput(jobTitleExp)" />
                                                <button type="button" class="w-full btn btn-primary"
                                                    (click)="confirmationPanel($event)"><i
                                                        class="fa fa-plus"></i>&nbsp;Add
                                                    New
                                                </button>
                                            </p-inputgroup>
                                            <p-confirmpopup>
                                            </p-confirmpopup>
                                        </div>
                                    </ng-template>
                                </p-select>
                                <small class="text-danger" *ngIf="isFieldInvalid(i, 'jobTitle')">
                                    {{ getFieldError(i, 'jobTitle') }}
                                </small>
                            </div>
                            <div class="mb-3">
                                <div class="col-12 col-md-3 w-100">
                                    <label class="mb-2 d-block">Current Gross Salary /Month</label>
                                    <div class="row">
                                        <div class="col-4">
                                            <p-select formControlName="currency" [filter]="true"
                                                filterBy="currency_code" [options]="currencies"
                                                placeholder="Select Currency" styleClass="w-100"
                                                optionLabel="currency_code" optionValue="currency_code">
                                            </p-select>
                                            <small class="text-danger" *ngIf="isFieldInvalid(i, 'currency')">
                                                {{ getFieldError(i, 'currency') }}
                                            </small>
                                        </div>
                                        <div class="col-8">
                                            <p-input-number formControlName="current_salary" class="w-100"
                                                placeholder="Current Gross Salary /Month">
                                            </p-input-number>
                                            <small class="text-danger" *ngIf="isFieldInvalid(i, 'current_salary')">
                                                {{ getFieldError(i, 'current_salary') }}
                                            </small>
                                        </div>
                                    </div>
                                    <!-- Add error message -->

                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Prefered Location</label>
                                <p-select fluid appendTo="body" class="w-100" formControlName="work_location"
                                    [options]="workLocation" placeholder="City, Country" optionLabel="work_location"
                                    optionValue="id" [virtualScroll]="true" [virtualScrollItemSize]="20"
                                    [virtualScrollOptions]="workLocation" [filter]="true" filterBy="work_location"
                                    class="w-full md:w-56" [showClear]="false" dataKey="id"
                                    (mouseover)="onFocusInput('workLocation')"
                                    (mouseout)="resetMessageBox()"></p-select>
                                <small class="text-danger" *ngIf="isFieldInvalid(i, 'work_location')">
                                    {{ getFieldError(i, 'work_location') }}
                                </small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Prefered Work Type</label>
                                <p-multiselect class="w-100" appendTo="body" formControlName="employment_type"
                                    [options]="dropdownData.employmenttype" placeholder="Select Employment Type"
                                    optionValue="id" optionLabel="employment_type" dataKey="id" [filter]="true"
                                    filterBy="employment_type" [showClear]="false"
                                    (mouseover)="onFocusInput('employementType')"
                                    (mouseout)="resetMessageBox()"></p-multiselect>
                                <small class="text-danger" *ngIf="isFieldInvalid(i, 'employment_type')">
                                    {{ getFieldError(i, 'employment_type') }}
                                </small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Prefered Work Mode</label>
                                <p-select fluid appendTo="body" class="w-100" formControlName="work_mode"
                                    [options]="workMode" placeholder="Remote/On-site/Hybrid" optionLabel="label"
                                    optionValue="value" [virtualScroll]="true" [virtualScrollItemSize]="20"
                                    [filter]="true" filterBy="label" class="w-full md:w-56" [showClear]="false"
                                    dataKey="id" (mouseover)="onFocusInput('workMode')"
                                    (mouseout)="resetMessageBox()"></p-select>
                                <small class="text-danger" *ngIf="isFieldInvalid(i, 'work_mode')">
                                    {{ getFieldError(i, 'work_mode') }}
                                </small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Other Comments</label>
                                <textarea rows="4" cols="30" placeholder="Add any Comments" styleClass="w-100" pTextarea
                                    formControlName="remarks" fluid></textarea>
                            </div>
                        </div>
                    </div>
                </ng-container>

                <!-- <div class="d-flex justify-content-center">
                    <button type="button" class="btn btn-primary" (click)="addRequirement()">
                        Add another Requirement
                    </button>
                </div> -->
            </div>

        </form>
    </div>
</div>
<div class="hs-footer d-flex justify-content-between align-items-center" *ngIf="!supportView">
    <div>
        <div class="text-muted">Total</div>
        <div class="h5 mb-0">{{ currency }} {{ totalAmount.toFixed(2) }}</div>
    </div>
    <button type="button" class="btn btn-success" (click)="postRequirement()">Post my Requirement</button>
</div>

<div style="width: 100%; height: 80vh; overflow: auto; overflow-x: hidden" class="mt-2 table-employer bg-white" *ngIf="supportView">
    <p-table size="small" scrollHeight="600px" [value]="employeesList" [tableStyle]="{ 'min-width': '110rem' }"
        dataKey="id" [rowHover]="true" [scrollable]="true">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="employername">
                    Talent Name <p-sortIcon field="talentname"></p-sortIcon>
                </th>
                <th pSortableColumn="is_payment_completed ">
                    Payment Status <p-sortIcon field="is_payment_completed "></p-sortIcon>
                </th>
                <th pSortableColumn="amount">
                    Amount <p-sortIcon field="amount"></p-sortIcon>
                </th>
                <th pSortableColumn="actions">
                    Actions <p-sortIcon field="actions"></p-sortIcon>
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-employee>
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <img [src]="employee?.profile_image" class="rounded-circle mr-2" width="40" height="40" />
                        <div>
                            {{ employee?.talentname }} <br />
                            <small class="text-muted">Profile Updated On {{ employee?.updated_at }}</small>
                        </div>
                    </div>
                </td>
                <td>
                    {{ employee?.is_payment_completed == 1 ? 'Paid' : 'Unpaid' }}
                </td>
                <td>{{ employee?.amount }}</td>
                <td>
                    <div class="d-flex flex-column gap-2" style="font-size: 15px">
                        <span style="cursor: pointer" (click)="openInfoDialog(employee)"><i
                                class="pi pi-briefcase"></i>&nbsp;View
                            Info</span>
                    </div>
                </td>
            </tr>
        </ng-template>
         <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="3" class="text-center p-4">
                    No data available
                </td>
            </tr>
        </ng-template>
    </p-table>
    <p-scrollTop target="parent" styleClass="custom-scrolltop" [threshold]="100" icon="pi pi-arrow-up"></p-scrollTop>

    <div class="footer-section p-3 d-flex justify-content-center">
        <p-paginator (onPageChange)="pageChange($event)" [rows]="perPage" [totalRecords]="totalEmployeeCount"
            [rowsPerPageOptions]="[10, 50, 100]"></p-paginator>
    </div>
</div>

<p-dialog header="Requirement Details" [(visible)]="showInfoDialog" [modal]="true" [style]="{ width: '900px' }">
    @if (selectedRequirement?.length > 0) {
    <p-table [value]="selectedRequirement" styleClass="p-datatable-sm" [tableStyle]="{ 'min-width': '100%' }"
        [rowHover]="true">
        <ng-template pTemplate="header">
            <tr>
                <th>Job Title</th>
                <th>Talent Requirement Plan</th>
                <th>Work Mode</th>
                <th>Work Type</th>
                <th>Location</th>
                <th>Currency</th>
                <th>Current Salary</th>
                <th>Comments</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-req>
            <tr>
                <td>{{ req.position_title || 'N/A' }}</td>
                <td>{{ req.talent_requirement_plan }}</td>
                <td>{{ req.preferred_work_mode || 'Any' }}</td>
                <td>{{ req.work_type || 'Any' }}</td>
                <td>{{ req.location }}</td>
                <td>{{ req.currency }}</td>
                <td>{{ req.current_salary}}</td>
                <td>
                    <span *ngIf="!req?.comments">
                        -
                    </span>
                    <ng-container *ngIf="req?.comments">
                        <span *ngIf="!req.showFull">
                            {{ req.comments | slice:0:20 }}
                            <span *ngIf="req.comments.length > 20">...</span>
                            <a *ngIf="req.comments.length > 20" class="text-primary cursor-pointer"
                                (click)="req.showFull = true">more</a>
                        </span>

                        <span *ngIf="req.showFull">
                            {{ req.comments }}
                            <a class="text-primary cursor-pointer" (click)="req.showFull = false">less</a>
                        </span>
                    </ng-container>
                </td>

            </tr>
        </ng-template>
    </p-table>
    } @else {
    <p class="text-center text-muted m-3">No requirements found for this talent.</p>
    }
</p-dialog>